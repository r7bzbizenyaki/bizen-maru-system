<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ã‚­ãƒ£ãƒ³ç®¡ç† - å‚™å‰ä¸¸å†…è¦§ä¼š</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif;
            background: linear-gradient(135deg, #1A2B4A 0%, #2C4A7C 100%);
            min-height: 100vh;
            padding: 15px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #C41E3A 0%, #8B0000 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            text-align: center;
        }
        
        .header h1 {
            font-size: 22px;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .debug-panel {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .debug-panel h4 {
            margin-bottom: 5px;
            color: #856404;
        }
        
        .debug-log {
            color: #856404;
            font-family: monospace;
            line-height: 1.4;
        }
        
        .mode-selector {
            background: white;
            padding: 20px;
            display: flex;
            gap: 10px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, #C41E3A 0%, #8B0000 100%);
            color: white;
            border-color: #C41E3A;
        }
        
        .scanner-section {
            background: white;
            padding: 20px;
        }
        
        .camera-btn {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .camera-btn:active {
            transform: scale(0.98);
        }
        
        .camera-btn.scanning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }
        
        #reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto 20px;
            display: none;
        }
        
        #reader.active {
            display: block;
        }
        
        #reader video {
            width: 100%;
            border-radius: 10px;
            background: #000;
        }
        
        .manual-input {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
        
        .manual-input h3 {
            color: #1A2B4A;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .input-group button {
            padding: 12px 25px;
            background: #C41E3A;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .result-section {
            background: white;
            padding: 20px;
            border-radius: 0 0 15px 15px;
        }
        
        .result-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
        }
        
        .result-message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .result-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .result-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        .stats-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
        
        .stats-title {
            font-size: 16px;
            font-weight: bold;
            color: #1A2B4A;
            margin-bottom: 15px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #C41E3A;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>â›µ å‚™å‰ä¸¸ ã‚¹ã‚­ãƒ£ãƒ³ç®¡ç†</h1>
            <p>ä¿‚å“¡ç”¨ç®¡ç†ç”»é¢ï¼ˆãƒ‡ãƒãƒƒã‚°å¼·åŒ–ç‰ˆï¼‰</p>
        </div>
        
        <div class="debug-panel" id="debugPanel">
            <h4>ğŸ” ã‚¹ã‚­ãƒ£ãƒ³ãƒ­ã‚°</h4>
            <div class="debug-log" id="debugLog">å¾…æ©Ÿä¸­...</div>
        </div>
        
        <div class="mode-selector">
            <button class="mode-btn active" id="boardingBtn" onclick="setMode('boarding')">
                ğŸš¢ ä¹—èˆ¹
            </button>
            <button class="mode-btn" id="disembarkBtn" onclick="setMode('disembark')">
                ğŸ‘‹ ä¸‹èˆ¹
            </button>
        </div>
        
        <div class="scanner-section">
            <button class="camera-btn" id="cameraBtn" onclick="toggleCamera()">
                ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹
            </button>
            
            <div id="reader"></div>
            
            <div class="manual-input">
                <h3>ğŸ”¢ æ‰‹å‹•å…¥åŠ›ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ï¼‰</h3>
                <div class="input-group">
                    <input type="text" id="manualId" placeholder="ãƒã‚±ãƒƒãƒˆID (ä¾‹: BM1234567890)">
                    <button onclick="manualScan()">è¨˜éŒ²</button>
                </div>
            </div>
        </div>
        
        <div class="result-section">
            <div id="resultContainer"></div>
            
            <div class="stats-section">
                <div class="stats-title">ğŸ“Š æœ¬æ—¥ã®çµ±è¨ˆ</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalBoarding">0</div>
                        <div class="stat-label">ä¹—èˆ¹è€…æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalDisembark">0</div>
                        <div class="stat-label">ä¸‹èˆ¹è€…æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="currentOnboard">0</div>
                        <div class="stat-label">èˆ¹å†…äººæ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgStay">-</div>
                        <div class="stat-label">å¹³å‡æ»åœ¨æ™‚é–“</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentMode = 'boarding';
        let html5QrCode = null;
        let isScanning = false;
        let scanData = JSON.parse(localStorage.getItem('scanData') || '{}');
        let allTickets = JSON.parse(localStorage.getItem('allTickets') || '[]');
        let stats = JSON.parse(localStorage.getItem('stats') || '{"boarding": 0, "disembark": 0}');
        let lastScanTime = 0;
        let debugLogs = [];
        
        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
        function addDebugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLogs.unshift(`[${timestamp}] ${message}`);
            if (debugLogs.length > 10) debugLogs.pop();
            document.getElementById('debugLog').innerHTML = debugLogs.join('<br>');
            console.log(message);
        }
        
        // åˆæœŸåŒ–
        window.onload = function() {
            updateStats();
            addDebugLog('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
        };
        
        // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        function setMode(mode) {
            currentMode = mode;
            document.getElementById('boardingBtn').classList.toggle('active', mode === 'boarding');
            document.getElementById('disembarkBtn').classList.toggle('active', mode === 'disembark');
            addDebugLog(`ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿: ${mode === 'boarding' ? 'ä¹—èˆ¹' : 'ä¸‹èˆ¹'}`);
        }
        
        // ã‚«ãƒ¡ãƒ©èµ·å‹•/åœæ­¢
        async function toggleCamera() {
            const btn = document.getElementById('cameraBtn');
            const reader = document.getElementById('reader');
            
            if (isScanning) {
                try {
                    await html5QrCode.stop();
                    isScanning = false;
                    btn.textContent = 'ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹';
                    btn.classList.remove('scanning');
                    reader.classList.remove('active');
                    showResult('info', 'ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ');
                    addDebugLog('ã‚«ãƒ¡ãƒ©åœæ­¢');
                } catch (err) {
                    addDebugLog('åœæ­¢ã‚¨ãƒ©ãƒ¼: ' + err.message);
                }
            } else {
                try {
                    showResult('info', 'ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...');
                    addDebugLog('ã‚«ãƒ¡ãƒ©èµ·å‹•é–‹å§‹...');
                    btn.textContent = 'ğŸ”„ èµ·å‹•ä¸­...';
                    btn.disabled = true;
                    
                    if (!html5QrCode) {
                        html5QrCode = new Html5Qrcode("reader");
                        addDebugLog('Html5Qrcodeã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ');
                    }
                    
                    const config = {
                        fps: 20,  // èª­ã¿å–ã‚Šé€Ÿåº¦ã‚’ä¸Šã’ã‚‹
                        qrbox: function(viewfinderWidth, viewfinderHeight) {
                            // èª­ã¿å–ã‚Šç¯„å›²ã‚’åºƒã’ã‚‹
                            let minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                            let qrboxSize = Math.floor(minEdge * 0.8);
                            return {
                                width: qrboxSize,
                                height: qrboxSize
                            };
                        },
                        aspectRatio: 1.0,
                        // èª­ã¿å–ã‚Šæ„Ÿåº¦ã‚’æœ€å¤§ã«
                        experimentalFeatures: {
                            useBarCodeDetectorIfSupported: true
                        }
                    };
                    
                    await html5QrCode.start(
                        { facingMode: "environment" },
                        config,
                        onScanSuccess,
                        onScanFailure
                    );
                    
                    isScanning = true;
                    btn.textContent = 'â¹ï¸ ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢';
                    btn.classList.add('scanning');
                    btn.disabled = false;
                    reader.classList.add('active');
                    showResult('success', `ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ï¼QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„`);
                    addDebugLog('ã‚«ãƒ¡ãƒ©èµ·å‹•æˆåŠŸ - ã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­');
                    
                } catch (err) {
                    btn.textContent = 'ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹';
                    btn.disabled = false;
                    
                    let errorMsg = 'ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
                    
                    if (err.toString().includes('NotAllowedError') || err.toString().includes('Permission')) {
                        errorMsg += '<br><br><b>ã‚«ãƒ¡ãƒ©ã®æ¨©é™ã‚’è¨±å¯ã—ã¦ãã ã•ã„</b>';
                    }
                    errorMsg += '<br><br>æ‰‹å‹•å…¥åŠ›ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚';
                    
                    showResult('error', errorMsg);
                    addDebugLog('ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: ' + err.message);
                }
            }
        }
        
        // QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚ŠæˆåŠŸ
        function onScanSuccess(decodedText, decodedResult) {
            const now = Date.now();
            
            addDebugLog(`QRæ¤œå‡º: "${decodedText.substring(0, 50)}${decodedText.length > 50 ? '...' : ''}"`);
            
            // é€£ç¶šã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢ï¼ˆ1ç§’é–“éš”ï¼‰
            if (now - lastScanTime < 1000) {
                addDebugLog('é€£ç¶šã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢ (1ç§’ä»¥å†…)');
                return;
            }
            lastScanTime = now;
            
            try {
                // JSONå½¢å¼ã‚’è©¦ã™
                const data = JSON.parse(decodedText);
                addDebugLog(`JSONè§£ææˆåŠŸ: ID=${data.id}, Name=${data.name}`);
                processScan(data.id, data.name);
            } catch (e) {
                // JSONå½¢å¼ã§ãªã„å ´åˆ
                addDebugLog('JSONè§£æå¤±æ•— - ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚¹ãƒˆã¨ã—ã¦å‡¦ç†');
                
                // BMã§å§‹ã¾ã‚‹ãƒã‚±ãƒƒãƒˆIDã¨ã—ã¦æ‰±ã†
                if (decodedText.startsWith('BM')) {
                    addDebugLog(`ãƒã‚±ãƒƒãƒˆIDã¨ã—ã¦å‡¦ç†: ${decodedText}`);
                    processScan(decodedText, null);
                } else {
                    addDebugLog(`ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰å½¢å¼: ${decodedText}`);
                    showResult('error', 'ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã™<br><small>å‚™å‰ä¸¸ã®ãƒã‚±ãƒƒãƒˆQRã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„</small>');
                }
            }
        }
        
        // QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šå¤±æ•—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        function onScanFailure(error) {
            // ã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­ã®ã‚¨ãƒ©ãƒ¼ã¯é »ç¹ã«ç™ºç”Ÿã™ã‚‹ã®ã§ãƒ­ã‚°ã«æ®‹ã•ãªã„
        }
        
        // ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç†
        async function processScan(ticketId, name) {
            const timestamp = Date.now();
            const mode = currentMode;
            
            addDebugLog(`å‡¦ç†é–‹å§‹: ID=${ticketId}, Mode=${mode}`);
            
            // allTicketsã‹ã‚‰åå‰ã‚’å–å¾—
            if (!name) {
                const ticket = allTickets.find(t => t.id === ticketId);
                if (ticket) {
                    name = ticket.name;
                    addDebugLog(`allTicketsã‹ã‚‰åå‰å–å¾—: ${name}`);
                }
            }
            
            if (!scanData[ticketId]) {
                scanData[ticketId] = {
                    name: name,
                    entry_time: timestamp,
                    boarding_time: null,
                    disembark_time: null
                };
                addDebugLog(`æ–°è¦ãƒã‚±ãƒƒãƒˆç™»éŒ²: ${ticketId}`);
            }
            
            if (mode === 'boarding') {
                if (scanData[ticketId].boarding_time) {
                    showResult('error', `âŒ ${name || ticketId} ã•ã‚“ã¯æ—¢ã«ä¹—èˆ¹æ¸ˆã¿ã§ã™`);
                    addDebugLog(`ä¹—èˆ¹æ¸ˆã¿ã‚¨ãƒ©ãƒ¼: ${ticketId}`);
                    return;
                }
                scanData[ticketId].boarding_time = timestamp;
                stats.boarding++;
                showResult('success', `âœ… ${name || ticketId} ã•ã‚“ã®ä¹—èˆ¹ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ`);
                addDebugLog(`ä¹—èˆ¹è¨˜éŒ²æˆåŠŸ: ${name || ticketId}`);
            } else {
                if (!scanData[ticketId].boarding_time) {
                    showResult('error', `âŒ ${name || ticketId} ã•ã‚“ã¯ã¾ã ä¹—èˆ¹ã—ã¦ã„ã¾ã›ã‚“`);
                    addDebugLog(`æœªä¹—èˆ¹ã‚¨ãƒ©ãƒ¼: ${ticketId}`);
                    return;
                }
                if (scanData[ticketId].disembark_time) {
                    showResult('error', `âŒ ${name || ticketId} ã•ã‚“ã¯æ—¢ã«ä¸‹èˆ¹æ¸ˆã¿ã§ã™`);
                    addDebugLog(`ä¸‹èˆ¹æ¸ˆã¿ã‚¨ãƒ©ãƒ¼: ${ticketId}`);
                    return;
                }
                scanData[ticketId].disembark_time = timestamp;
                stats.disembark++;
                
                const stayTime = Math.floor((timestamp - scanData[ticketId].boarding_time) / 60000);
                showResult('success', `âœ… ${name || ticketId} ã•ã‚“ã®ä¸‹èˆ¹ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ<br><small>æ»åœ¨æ™‚é–“: ${stayTime}åˆ†</small>`);
                addDebugLog(`ä¸‹èˆ¹è¨˜éŒ²æˆåŠŸ: ${name || ticketId} (æ»åœ¨${stayTime}åˆ†)`);
            }
            
            localStorage.setItem('scanData', JSON.stringify(scanData));
            localStorage.setItem('stats', JSON.stringify(stats));
            
            // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
            if (navigator.onLine) {
                try {
                    await fetch('/api/scan/' + mode, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ticket_id: ticketId, timestamp: timestamp })
                    });
                    addDebugLog('ã‚µãƒ¼ãƒãƒ¼é€ä¿¡æˆåŠŸ');
                } catch (err) {
                    addDebugLog('ã‚µãƒ¼ãƒãƒ¼é€ä¿¡ã‚¨ãƒ©ãƒ¼ (ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜æ¸ˆã¿)');
                }
            }
            
            updateStats();
        }
        
        // æ‰‹å‹•å…¥åŠ›
        function manualScan() {
            const ticketId = document.getElementById('manualId').value.trim();
            if (!ticketId) {
                showResult('error', 'ãƒã‚±ãƒƒãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (!ticketId.startsWith('BM')) {
                showResult('error', 'ãƒã‚±ãƒƒãƒˆIDã¯BMã§å§‹ã¾ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
                return;
            }
            processScan(ticketId, null);
            document.getElementById('manualId').value = '';
        }
        
        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            document.getElementById('totalBoarding').textContent = stats.boarding || 0;
            document.getElementById('totalDisembark').textContent = stats.disembark || 0;
            document.getElementById('currentOnboard').textContent = 
                (stats.boarding || 0) - (stats.disembark || 0);
            
            let totalStay = 0;
            let completedVisits = 0;
            for (let id in scanData) {
                const data = scanData[id];
                if (data.boarding_time && data.disembark_time) {
                    totalStay += data.disembark_time - data.boarding_time;
                    completedVisits++;
                }
            }
            if (completedVisits > 0) {
                const avgMinutes = Math.floor(totalStay / completedVisits / 60000);
                document.getElementById('avgStay').textContent = avgMinutes + 'åˆ†';
            }
        }
        
        // çµæœè¡¨ç¤º
        function showResult(type, message) {
            const container = document.getElementById('resultContainer');
            container.innerHTML = `<div class="result-message ${type}">${message}</div>`;
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, type === 'success' ? 3000 : 5000);
            }
        }
        
        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«ã‚«ãƒ¡ãƒ©åœæ­¢
        window.addEventListener('beforeunload', async () => {
            if (isScanning && html5QrCode) {
                try {
                    await html5QrCode.stop();
                } catch (err) {
                    console.error('åœæ­¢ã‚¨ãƒ©ãƒ¼:', err);
                }
            }
        });
    </script>
</body>
</html>
