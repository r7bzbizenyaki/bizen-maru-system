<script>
    let currentDate = '2026-02-27';
    let allEntries = [];

    const TIMESLOTS = [
        { start: '09:00', end: '10:00' },
        { start: '10:00', end: '11:00' },
        { start: '11:00', end: '12:00' },
        { start: '13:00', end: '14:00' },
        { start: '14:00', end: '15:00' }
    ];

    const dateMap = {
        '2026-02-27': '2æœˆ27æ—¥ï¼ˆé‡‘ï¼‰',
        '2026-03-27': '3æœˆ27æ—¥ï¼ˆé‡‘ï¼‰',
        '2026-03-28': '3æœˆ28æ—¥ï¼ˆåœŸï¼‰'
    };

    const statusMap = {
        'reserved': { text: 'äºˆç´„æ¸ˆã¿', class: 'status-reserved' },
        'boarded': { text: 'ä¹—èˆ¹ä¸­', class: 'status-boarded' },
        'completed': { text: 'ä¸‹èˆ¹æ¸ˆã¿', class: 'status-completed' }
    };

    function init() {
        console.log('ğŸš€ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–');
        loadData();
        updateUI();
        startAutoRefresh();
    }

    function loadData() {
        allEntries = JSON.parse(localStorage.getItem('citizenEntries') || '[]');
        console.log('ğŸ“Š ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿:', allEntries.length, 'ä»¶');
        console.log('ğŸ“‹ èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿:', allEntries);
    }

    function updateUI() {
        updateStats();
        updateDateCounts();
        updateTimeslotGrid();
        updateParticipantTable();
        updateLastUpdateTime();
    }

    function updateStats() {
        console.log('ğŸ“Š çµ±è¨ˆè¨ˆç®—é–‹å§‹... ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ•°:', allEntries.length);
        
        const total = allEntries.length;
        const boarded = allEntries.filter(function(e) { return e.boardedAt; }).length;
        const completed = allEntries.filter(function(e) { return e.disembarkedAt; }).length;
        const onboard = allEntries.filter(function(e) { return e.boardedAt && !e.disembarkedAt; }).length;

        console.log('ğŸ“Š çµ±è¨ˆçµæœ:', { total: total, boarded: boarded, onboard: onboard, completed: completed });

        document.getElementById('totalReservations').textContent = total;
        document.getElementById('totalBoarded').textContent = boarded;
        document.getElementById('totalCompleted').textContent = completed;

        const completedEntries = allEntries.filter(function(e) { 
            return e.disembarkedAt && e.boardedAt; 
        });
        
        if (completedEntries.length > 0) {
            const totalStayTime = completedEntries.reduce(function(sum, e) {
                const boardTime = new Date(e.boardedAt).getTime();
                const disembarkTime = new Date(e.disembarkedAt).getTime();
                return sum + (disembarkTime - boardTime);
            }, 0);
            const avgMs = totalStayTime / completedEntries.length;
            const avgMin = Math.round(avgMs / 60000);
            document.getElementById('avgStayTime').textContent = avgMin + 'åˆ†';
        } else {
            document.getElementById('avgStayTime').textContent = '-';
        }

        console.log('ğŸ“Š çµ±è¨ˆæ›´æ–°å®Œäº†');
    }

    function updateDateCounts() {
        ['2026-02-27', '2026-03-27', '2026-03-28'].forEach(function(date) {
            const count = allEntries.filter(function(e) { return e.date === date; }).length;
            const id = 'count-' + date.slice(5).replace('-', '');
            const elem = document.getElementById(id);
            if (elem) {
                elem.textContent = count + 'äºº';
            }
        });
    }

    function updateTimeslotGrid() {
        const container = document.getElementById('timeslotGrid');
        const dateEntries = allEntries.filter(function(e) { return e.date === currentDate; });

        let html = '';
        TIMESLOTS.forEach(function(slot) {
            const count = dateEntries.filter(function(e) { return e.timeslot === slot.start; }).length;
            html += '<div class="timeslot-card"><div class="timeslot-time">' + slot.start + 'ã€œ' + slot.end + '</div><div class="timeslot-count">' + count + '</div><div class="timeslot-label">å¸Œæœ›è€…</div></div>';
        });

        container.innerHTML = html;
    }

    function updateParticipantTable() {
        const tbody = document.getElementById('participantTableBody');
        
        if (allEntries.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">ã¾ã äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
            return;
        }

        let html = '';
        allEntries.slice().reverse().forEach(function(entry) {
            let status = statusMap['reserved'];
            if (entry.disembarkedAt) {
                status = statusMap['completed'];
            } else if (entry.boardedAt) {
                status = statusMap['boarded'];
            }
            
            const dateDisplay = dateMap[entry.date] || entry.date;
            const slot = TIMESLOTS.find(function(s) { return s.start === entry.timeslot; });
            const timeDisplay = slot ? (slot.start + 'ã€œ' + slot.end) : entry.timeslot;

            html += '<tr><td><code>' + entry.id + '</code></td><td><strong>' + entry.name + '</strong></td><td>' + dateDisplay + '<br><small>' + timeDisplay + '</small></td><td>' + entry.phone + '</td><td>' + entry.email + '</td><td>' + entry.age + '</td><td>' + entry.gender + '</td><td><span class="status-badge ' + status.class + '">' + status.text + '</span></td></tr>';
        });

        tbody.innerHTML = html;
    }

    function updateLastUpdateTime() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('ja-JP');
        document.getElementById('lastUpdateTime').textContent = timeStr;
    }

    function switchDate(date) {
        currentDate = date;
        
        document.querySelectorAll('.date-tab').forEach(function(tab) {
            tab.classList.remove('active');
            if (tab.dataset.date === date) {
                tab.classList.add('active');
            }
        });

        updateTimeslotGrid();
        console.log('ğŸ“… æ—¥ä»˜åˆ‡æ›¿:', date);
    }

    function applyFilters() {
        const filterDate = document.getElementById('filterDate').value;
        const filterTimeslot = document.getElementById('filterTimeslot').value;
        const filterStatus = document.getElementById('filterStatus').value;

        let filtered = allEntries;

        if (filterDate) {
            filtered = filtered.filter(function(e) { return e.date === filterDate; });
        }

        if (filterTimeslot) {
            filtered = filtered.filter(function(e) { return e.timeslot === filterTimeslot; });
        }

        if (filterStatus) {
            if (filterStatus === 'reserved') {
                filtered = filtered.filter(function(e) { return !e.boardedAt; });
            } else if (filterStatus === 'boarded') {
                filtered = filtered.filter(function(e) { return e.boardedAt && !e.disembarkedAt; });
            } else if (filterStatus === 'completed') {
                filtered = filtered.filter(function(e) { return e.disembarkedAt; });
            }
        }

        console.log('ğŸ” ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨:', filtered.length, 'ä»¶');

        const tbody = document.getElementById('participantTableBody');
        
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">è©²å½“ã™ã‚‹äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
            return;
        }

        let html = '';
        filtered.slice().reverse().forEach(function(entry) {
            let status = statusMap['reserved'];
            if (entry.disembarkedAt) {
                status = statusMap['completed'];
            } else if (entry.boardedAt) {
                status = statusMap['boarded'];
            }
            
            const dateDisplay = dateMap[entry.date] || entry.date;
            const slot = TIMESLOTS.find(function(s) { return s.start === entry.timeslot; });
            const timeDisplay = slot ? (slot.start + 'ã€œ' + slot.end) : entry.timeslot;

            html += '<tr><td><code>' + entry.id + '</code></td><td><strong>' + entry.name + '</strong></td><td>' + dateDisplay + '<br><small>' + timeDisplay + '</small></td><td>' + entry.phone + '</td><td>' + entry.email + '</td><td>' + entry.age + '</td><td>' + entry.gender + '</td><td><span class="status-badge ' + status.class + '">' + status.text + '</span></td></tr>';
        });

        tbody.innerHTML = html;
    }

    function refreshData() {
        const syncBadge = document.getElementById('syncBadge');
        syncBadge.textContent = 'ğŸ”„ åŒæœŸä¸­...';
        syncBadge.classList.add('syncing');

        setTimeout(function() {
            loadData();
            updateUI();
            syncBadge.textContent = 'âœ… æ›´æ–°å®Œäº†';
            syncBadge.classList.remove('syncing');
            
            setTimeout(function() {
                syncBadge.textContent = 'âœ… åŒæœŸä¸­';
            }, 2000);
        }, 500);

        console.log('ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°');
    }

    function exportCSV() {
        if (allEntries.length === 0) {
            alert('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }

        const headers = ['ãƒã‚±ãƒƒãƒˆID', 'åå‰', 'äºˆç´„æ—¥', 'å¸Œæœ›æ™‚é–“', 'é›»è©±ç•ªå·', 'ãƒ¡ãƒ¼ãƒ«', 'éƒµä¾¿ç•ªå·', 'ä½æ‰€', 'å¹´é½¢å±¤', 'æ€§åˆ¥', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'äºˆç´„æ—¥æ™‚'];
        const rows = allEntries.map(function(e) {
            const slot = TIMESLOTS.find(function(s) { return s.start === e.timeslot; });
            const timeDisplay = slot ? (slot.start + 'ã€œ' + slot.end) : e.timeslot;
            
            let statusText = 'äºˆç´„æ¸ˆã¿';
            if (e.disembarkedAt) {
                statusText = 'ä¸‹èˆ¹æ¸ˆã¿';
            } else if (e.boardedAt) {
                statusText = 'ä¹—èˆ¹ä¸­';
            }
            
            const timestamp = new Date(e.timestamp).toLocaleString('ja-JP');

            return [
                e.id,
                e.name,
                dateMap[e.date] || e.date,
                timeDisplay,
                e.phone,
                e.email,
                e.postal,
                e.address,
                e.age,
                e.gender,
                statusText,
                timestamp
            ].join(',');
        });

        const csv = [headers.join(',')].concat(rows).join('\n');
        const bom = '\uFEFF';
        const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', 'å‚™å‰ä¸¸å¸‚æ°‘é™å®šå†…è¦§ä¼š_äºˆç´„ä¸€è¦§_' + new Date().toISOString().slice(0,10) + '.csv');
        link.click();

        console.log('ğŸ“¥ CSVå‡ºåŠ›å®Œäº†');
    }

    function clearAllData() {
        if (!confirm('æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
            return;
        }

        if (!confirm('æœ€çµ‚ç¢ºèªï¼šã™ã¹ã¦ã®äºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚\næœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
            return;
        }

        localStorage.removeItem('citizenEntries');
        localStorage.setItem('lastUpdate', Date.now().toString());
        
        allEntries = [];
        updateUI();

        alert('âœ… å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        console.log('ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢å®Œäº†');
    }

    function startAutoRefresh() {
        setInterval(function() {
            loadData();
            updateUI();
            console.log('ğŸ”„ è‡ªå‹•æ›´æ–°å®Ÿè¡Œ');
        }, 5000);
    }

    window.addEventListener('storage', function(e) {
        if (e.key === 'citizenEntries' || e.key === 'lastUpdate') {
            console.log('ğŸ”„ ä»–ã®ã‚¿ãƒ–ã‹ã‚‰ã®æ›´æ–°æ¤œå‡º');
            refreshData();
        }
    });

    init();

    console.log('ğŸš€ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰èµ·å‹•å®Œäº†');
</script>
