<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - å‚™å‰ä¸¸å†…è¦§ä¼š</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #C41E3A 0%, #8B0000 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .sync-indicator {
            display: inline-block;
            padding: 5px 12px;
            background: #4CAF50;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .stat-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 42px;
            font-weight: bold;
            color: #C41E3A;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .data-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #1A2B4A;
        }
        
        .export-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .data-table thead {
            background: #f8f8f8;
        }
        
        .data-table th {
            padding: 12px;
            text-align: left;
            font-weight: bold;
            color: #1A2B4A;
            border-bottom: 2px solid #ddd;
        }
        
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .data-table tr:hover {
            background: #f9f9f9;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-completed {
            background: #E8F5E9;
            color: #2E7D32;
        }
        
        .status-onboard {
            background: #FFF3E0;
            color: #E65100;
        }
        
        .status-registered {
            background: #E3F2FD;
            color: #1565C0;
        }
        
        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .chart-title {
            font-weight: bold;
            color: #1A2B4A;
            margin-bottom: 15px;
        }
        
        .bar-chart {
            display: flex;
            align-items: flex-end;
            height: 200px;
            gap: 10px;
            margin-top: 10px;
        }
        
        .bar {
            flex: 1;
            background: linear-gradient(180deg, #C41E3A 0%, #8B0000 100%);
            border-radius: 8px 8px 0 0;
            position: relative;
            min-height: 20px;
            transition: all 0.3s;
        }
        
        .bar:hover {
            opacity: 0.8;
        }
        
        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 12px;
            color: #666;
        }
        
        .bar-value {
            position: absolute;
            top: -25px;
            left: 0;
            right: 0;
            text-align: center;
            font-weight: bold;
            color: #1A2B4A;
        }
        
        .refresh-time {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #C41E3A 0%, #8B0000 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #555;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>â›µ å‚™å‰ä¸¸ å†…è¦§ä¼š ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ <span class="sync-indicator" id="syncIndicator">ğŸ”„ åŒæœŸä¸­</span></h1>
            <p>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç®¡ç†ãƒ»çµ±è¨ˆãƒ»ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-value" id="totalVisitors">0</div>
                <div class="stat-label">ç·ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ•°</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">ğŸš¢</div>
                <div class="stat-value" id="totalBoarding">0</div>
                <div class="stat-label">ä¹—èˆ¹è€…æ•°</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘‹</div>
                <div class="stat-value" id="totalDisembark">0</div>
                <div class="stat-label">ä¸‹èˆ¹è€…æ•°</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">â±ï¸</div>
                <div class="stat-value" id="avgStay">-</div>
                <div class="stat-label">å¹³å‡æ»åœ¨æ™‚é–“</div>
            </div>
        </div>
        
        <div class="data-section">
            <div class="section-header">
                <div class="section-title">ğŸ“Š å‚åŠ è€…å±æ€§åˆ†æ</div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">å¹´ä»£åˆ¥å‚åŠ è€…æ•°</div>
                <div class="bar-chart" id="ageChart"></div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">æ€§åˆ¥åˆ†å¸ƒ</div>
                <div class="bar-chart" id="genderChart"></div>
            </div>
        </div>
        
        <div class="data-section">
            <div class="section-header">
                <div class="section-title">ğŸ“‹ å‚åŠ è€…ãƒªã‚¹ãƒˆ</div>
                <button class="export-btn" onclick="exportToCSV()">ğŸ“¥ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ãƒã‚±ãƒƒãƒˆID</th>
                            <th>ãŠåå‰</th>
                            <th>å¹´ä»£</th>
                            <th>æ€§åˆ¥</th>
                            <th>é€£çµ¡å…ˆ</th>
                            <th>ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ™‚åˆ»</th>
                            <th>ä¹—èˆ¹æ™‚åˆ»</th>
                            <th>ä¸‹èˆ¹æ™‚åˆ»</th>
                            <th>æ»åœ¨æ™‚é–“</th>
                            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <tr>
                            <td colspan="10" style="text-align: center; color: #999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="refreshData()">ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°</button>
            <button class="btn btn-secondary" onclick="clearAllData()">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
        </div>
        
        <div class="refresh-time" id="refreshTime">æœ€çµ‚æ›´æ–°: -</div>
    </div>
    
    <script>
        let allData = [];
        
        // åˆæœŸåŒ–
        window.onload = function() {
            loadData();
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸï¼ˆä»–ã®ã‚¿ãƒ–ã§ã®å¤‰æ›´ã‚’æ¤œçŸ¥ï¼‰
            window.addEventListener('storage', function(e) {
                if (e.key === 'entries' || e.key === null) {
                    console.log('ä»–ã®ã‚¿ãƒ–ã§ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ');
                    loadData();
                    flashSyncIndicator();
                }
            });
            
            // å®šæœŸçš„ãªè‡ªå‹•æ›´æ–°ï¼ˆ5ç§’ã”ã¨ï¼‰
            setInterval(loadData, 5000);
        };
        
        function flashSyncIndicator() {
            const indicator = document.getElementById('syncIndicator');
            indicator.style.background = '#FF9800';
            indicator.textContent = 'âœ… æ›´æ–°';
            setTimeout(() => {
                indicator.style.background = '#4CAF50';
                indicator.textContent = 'ğŸ”„ åŒæœŸä¸­';
            }, 1000);
        }
        
        function loadData() {
            // çµ±ä¸€ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼ 'entries' ã‹ã‚‰èª­ã¿è¾¼ã¿
            const entries = JSON.parse(localStorage.getItem('entries') || '[]');
            
            allData = entries.map(entry => ({
                id: entry.id,
                name: entry.name || 'ã‚²ã‚¹ãƒˆ',
                age: entry.age || '-',
                gender: entry.gender || '-',
                phone: entry.phone || '-',
                email: entry.email || '-',
                address: entry.address || '-',
                entry_time: entry.timestamp,
                boarding_time: entry.boardingTime || null,
                disembark_time: entry.alightingTime || null
            }));
            
            updateStats();
            updateCharts();
            updateTable();
            
            document.getElementById('refreshTime').textContent = 
                'æœ€çµ‚æ›´æ–°: ' + new Date().toLocaleTimeString('ja-JP');
        }
        
        function updateStats() {
            // ç·ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ•°
            document.getElementById('totalVisitors').textContent = allData.length;
            
            // ä¹—èˆ¹è€…æ•°
            const boarding = allData.filter(e => e.boarding_time).length;
            document.getElementById('totalBoarding').textContent = boarding;
            
            // ä¸‹èˆ¹è€…æ•°
            const disembark = allData.filter(e => e.disembark_time).length;
            document.getElementById('totalDisembark').textContent = disembark;
            
            // å¹³å‡æ»åœ¨æ™‚é–“
            let totalDuration = 0;
            let count = 0;
            
            allData.forEach(record => {
                if (record.boarding_time && record.disembark_time) {
                    const duration = (record.disembark_time - record.boarding_time) / 60000;
                    totalDuration += duration;
                    count++;
                }
            });
            
            if (count > 0) {
                document.getElementById('avgStay').textContent = Math.round(totalDuration / count) + 'åˆ†';
            } else {
                document.getElementById('avgStay').textContent = '-';
            }
        }
        
        function updateCharts() {
            // å¹´ä»£åˆ¥é›†è¨ˆ
            const ageData = {};
            allData.forEach(record => {
                const age = record.age || 'ä¸æ˜';
                ageData[age] = (ageData[age] || 0) + 1;
            });
            
            createBarChart('ageChart', ageData);
            
            // æ€§åˆ¥é›†è¨ˆ
            const genderData = {};
            allData.forEach(record => {
                const gender = record.gender || 'ä¸æ˜';
                genderData[gender] = (genderData[gender] || 0) + 1;
            });
            
            createBarChart('genderChart', genderData);
        }
        
        function createBarChart(containerId, data) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (Object.keys(data).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            const maxValue = Math.max(...Object.values(data));
            
            for (const [label, value] of Object.entries(data)) {
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = (value / maxValue * 100) + '%';
                
                const barValue = document.createElement('div');
                barValue.className = 'bar-value';
                barValue.textContent = value;
                
                const barLabel = document.createElement('div');
                barLabel.className = 'bar-label';
                barLabel.textContent = label;
                
                bar.appendChild(barValue);
                bar.appendChild(barLabel);
                container.appendChild(bar);
            }
        }
        
        function updateTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            if (allData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }
            
            allData.forEach(record => {
                const row = document.createElement('tr');
                
                const entryTime = record.entry_time ? new Date(record.entry_time).toLocaleString('ja-JP') : '-';
                const boardingTime = record.boarding_time ? new Date(record.boarding_time).toLocaleTimeString('ja-JP') : '-';
                const disembarkTime = record.disembark_time ? new Date(record.disembark_time).toLocaleTimeString('ja-JP') : '-';
                
                let duration = '-';
                let status = 'ç™»éŒ²æ¸ˆ';
                let statusClass = 'status-badge status-registered';
                
                if (record.boarding_time && record.disembark_time) {
                    const durationMin = Math.round((record.disembark_time - record.boarding_time) / 60000);
                    duration = durationMin + 'åˆ†';
                    status = 'å®Œäº†';
                    statusClass = 'status-badge status-completed';
                } else if (record.boarding_time) {
                    status = 'ä¹—èˆ¹ä¸­';
                    statusClass = 'status-badge status-onboard';
                }
                
                row.innerHTML = `
                    <td><small>${record.id}</small></td>
                    <td>${record.name}</td>
                    <td>${record.age}</td>
                    <td>${record.gender}</td>
                    <td><small>${record.phone}</small></td>
                    <td><small>${entryTime}</small></td>
                    <td><small>${boardingTime}</small></td>
                    <td><small>${disembarkTime}</small></td>
                    <td>${duration}</td>
                    <td><span class="${statusClass}">${status}</span></td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function exportToCSV() {
            if (allData.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // CSVãƒ˜ãƒƒãƒ€ãƒ¼
            let csv = '\uFEFF'; // BOM for Excel
            csv += 'ãƒã‚±ãƒƒãƒˆID,ãŠåå‰,å¹´ä»£,æ€§åˆ¥,é›»è©±ç•ªå·,ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹,ä½æ‰€,ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ—¥æ™‚,ä¹—èˆ¹æ™‚åˆ»,ä¸‹èˆ¹æ™‚åˆ»,æ»åœ¨æ™‚é–“ï¼ˆåˆ†ï¼‰,ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹\n';
            
            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            allData.forEach(record => {
                const entryTime = record.entry_time ? new Date(record.entry_time).toLocaleString('ja-JP') : '';
                const boardingTime = record.boarding_time ? new Date(record.boarding_time).toLocaleString('ja-JP') : '';
                const disembarkTime = record.disembark_time ? new Date(record.disembark_time).toLocaleString('ja-JP') : '';
                
                let duration = '';
                let status = 'ç™»éŒ²æ¸ˆ';
                if (record.boarding_time && record.disembark_time) {
                    duration = Math.round((record.disembark_time - record.boarding_time) / 60000);
                    status = 'å®Œäº†';
                } else if (record.boarding_time) {
                    status = 'ä¹—èˆ¹ä¸­';
                }
                
                csv += `"${record.id}","${record.name}","${record.age}","${record.gender}","${record.phone}","${record.email}","${record.address}","${entryTime}","${boardingTime}","${disembarkTime}","${duration}","${status}"\n`;
            });
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'å‚™å‰ä¸¸å†…è¦§ä¼šãƒ‡ãƒ¼ã‚¿_' + new Date().toISOString().split('T')[0] + '.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function refreshData() {
            loadData();
            flashSyncIndicator();
            alert('ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        }
        
        function clearAllData() {
            if (!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\n\n- ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿\n- ã‚¹ã‚­ãƒ£ãƒ³è¨˜éŒ²\n- å…¨çµ±è¨ˆæƒ…å ±\n\nã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
                return;
            }
            
            // çµ±ä¸€ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼ã‚’å…¨å‰Šé™¤
            localStorage.removeItem('entries');
            localStorage.removeItem('ticketEntries');
            localStorage.removeItem('scanRecords');
            localStorage.removeItem('scanData');
            localStorage.removeItem('stats');
            localStorage.removeItem('allTickets');
            
            // ä»–ã®ã‚¿ãƒ–ã«ã‚‚é€šçŸ¥ï¼ˆstorageã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ã®ãŸã‚ä¸€æ—¦setã—ã¦removeï¼‰
            localStorage.setItem('entries', '[]');
            localStorage.removeItem('entries');
            
            loadData();
            alert('âœ… å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }
    </script>
</body>
</html>
