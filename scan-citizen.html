<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ - å‚™å‰ä¸¸ å¸‚æ°‘é™å®šå†…è¦§ä¼š</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 20px;
      text-align: center;
    }
    .header h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    .mode-selector {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }
    .mode-btn {
      padding: 10px 20px;
      border: 2px solid white;
      background: transparent;
      color: white;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    .mode-btn.active {
      background: white;
      color: #667eea;
      font-weight: bold;
    }
    .content {
      padding: 30px 20px;
    }
    .camera-section {
      text-align: center;
      margin-bottom: 30px;
    }
    .camera-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 30px;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      transition: all 0.3s;
    }
    .camera-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    .camera-btn:active {
      transform: translateY(0);
    }
    #videoContainer {
      position: relative;
      width: 100%;
      max-width: 400px;
      margin: 20px auto;
      display: none;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    #video {
      width: 100%;
      display: block;
    }
    #scanFrame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 80%;
      border: 3px solid #4ade80;
      border-radius: 15px;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
      pointer-events: none;
    }
    #scanLine {
      position: absolute;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, transparent, #4ade80, transparent);
      animation: scan 2s linear infinite;
    }
    @keyframes scan {
      0%, 100% { top: 10%; }
      50% { top: 90%; }
    }
    .manual-section {
      margin-top: 30px;
      padding-top: 30px;
      border-top: 2px solid #f0f0f0;
    }
    .input-group {
      margin-bottom: 20px;
    }
    .input-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
    }
    .input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    .input-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary {
      background: #667eea;
      color: white;
    }
    .btn-primary:hover {
      background: #5568d3;
    }
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }
    .btn-secondary:hover {
      background: #e0e0e0;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 30px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    .stat-card h3 {
      font-size: 14px;
      margin-bottom: 10px;
      opacity: 0.9;
    }
    .stat-card .number {
      font-size: 32px;
      font-weight: bold;
    }
    .message {
      margin: 20px 0;
      padding: 15px;
      border-radius: 10px;
      display: none;
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .message.success {
      background: #d1fae5;
      color: #065f46;
      border: 2px solid #34d399;
    }
    .message.error {
      background: #fee2e2;
      color: #991b1b;
      border: 2px solid #f87171;
    }
    .message.info {
      background: #dbeafe;
      color: #1e40af;
      border: 2px solid #60a5fa;
    }
    .search-results {
      margin-top: 15px;
      max-height: 300px;
      overflow-y: auto;
    }
    .result-item {
      padding: 15px;
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .result-item:hover {
      background: #f3f4f6;
      border-color: #667eea;
    }
    .result-item h4 {
      margin-bottom: 5px;
      color: #1f2937;
    }
    .result-item p {
      font-size: 14px;
      color: #6b7280;
      margin: 3px 0;
    }
    .bottom-nav {
      display: flex;
      justify-content: space-around;
      padding: 20px;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
    }
    .nav-btn {
      text-decoration: none;
      color: #667eea;
      font-size: 14px;
      font-weight: 600;
      padding: 10px 20px;
      border-radius: 20px;
      transition: all 0.3s;
    }
    .nav-btn:hover {
      background: #667eea;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“± QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</h1>
      <p>å‚™å‰ä¸¸ å¸‚æ°‘é™å®šå†…è¦§ä¼š</p>
      <div class="mode-selector">
        <button class="mode-btn active" onclick="setMode('board')">ğŸš¢ ä¹—èˆ¹</button>
        <button class="mode-btn" onclick="setMode('disembark')">ğŸ  ä¸‹èˆ¹</button>
      </div>
    </div>

    <div class="content">
      <div class="camera-section">
        <button class="camera-btn" id="cameraBtn" onclick="toggleCamera()">
          ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
        </button>
        <div id="videoContainer">
          <video id="video" autoplay playsinline></video>
          <div id="scanFrame">
            <div id="scanLine"></div>
          </div>
        </div>
      </div>

      <div id="messageBox" class="message"></div>

      <div class="manual-section">
        <h3 style="margin-bottom: 15px; color: #333;">ğŸ” åå‰ãƒ»é›»è©±ç•ªå·ã§æ¤œç´¢</h3>
        <div class="input-group">
          <input type="text" id="searchInput" placeholder="åå‰ã¾ãŸã¯é›»è©±ç•ªå·ã‚’å…¥åŠ›">
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="searchEntry()">æ¤œç´¢</button>
        </div>
        <div id="searchResults" class="search-results"></div>
      </div>

      <div class="manual-section">
        <h3 style="margin-bottom: 15px; color: #333;">âœï¸ ãƒã‚±ãƒƒãƒˆIDã‚’æ‰‹å‹•å…¥åŠ›</h3>
        <div class="input-group">
          <input type="text" id="manualInput" placeholder="ãƒã‚±ãƒƒãƒˆIDï¼ˆä¾‹ï¼šCM1234567890ï¼‰">
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="recordManual()">è¨˜éŒ²ã™ã‚‹</button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <h3>ç·äºˆç´„æ•°</h3>
          <div class="number" id="totalCount">0</div>
        </div>
        <div class="stat-card">
          <h3>ä¹—èˆ¹æ¸ˆã¿</h3>
          <div class="number" id="boardedCount">0</div>
        </div>
        <div class="stat-card">
          <h3>ç¾åœ¨ä¹—èˆ¹ä¸­</h3>
          <div class="number" id="onboardCount">0</div>
        </div>
        <div class="stat-card">
          <h3>ä¸‹èˆ¹å®Œäº†</h3>
          <div class="number" id="disembarkedCount">0</div>
        </div>
      </div>
    </div>

    <div class="bottom-nav">
      <a href="dashboard-citizen.html" class="nav-btn">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
      <a href="index-citizen.html" class="nav-btn">ğŸ  ãƒˆãƒƒãƒ—ã¸</a>
    </div>
  </div>

  <script>
    let video = document.getElementById('video');
    let canvas = document.createElement('canvas');
    let ctx = canvas.getContext('2d');
    let isScanning = false;
    let scanInterval = null;
    let lastScannedId = '';
    let lastScannedTime = 0;
    let stream = null;
    let currentMode = 'board';

    const dateMap = {
      '2026-02-27': '2æœˆ27æ—¥ï¼ˆé‡‘ï¼‰',
      '2026-03-27': '3æœˆ27æ—¥ï¼ˆé‡‘ï¼‰',
      '2026-03-28': '3æœˆ28æ—¥ï¼ˆåœŸï¼‰'
    };

    function init() {
      updateStats();
      setInterval(updateStats, 5000);
    }

    function setMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      const modeText = mode === 'board' ? 'ä¹—èˆ¹' : 'ä¸‹èˆ¹';
      showMessage('info', 'ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´', modeText + 'ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ');
    }

    async function toggleCamera() {
      if (isScanning) {
        stopCamera();
      } else {
        await startCamera();
      }
    }

    async function startCamera() {
      try {
        console.log('ğŸ¥ ã‚«ãƒ¡ãƒ©èµ·å‹•é–‹å§‹...');
        
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
          stream = null;
        }

        const constraints = {
          video: {
            facingMode: { ideal: "environment" },
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        };

        console.log('ğŸ“¸ getUserMedia å‘¼ã³å‡ºã—ä¸­...');
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        console.log('âœ… ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ å–å¾—æˆåŠŸ');

        video.srcObject = stream;
        await video.play();
        console.log('âœ… ãƒ“ãƒ‡ã‚ªå†ç”Ÿé–‹å§‹');

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        document.getElementById('videoContainer').style.display = 'block';
        isScanning = true;
        
        const cameraBtn = document.getElementById('cameraBtn');
        cameraBtn.textContent = 'â¸ï¸ ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢';
        cameraBtn.style.background = '#ef4444';

        scanInterval = setInterval(scanQRCode, 150);
        
        showMessage('success', 'âœ… ã‚«ãƒ¡ãƒ©èµ·å‹•å®Œäº†ï¼', 'QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«æ˜ ã—ã¦ãã ã•ã„');
        console.log('âœ… ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹');

      } catch (error) {
        console.error('âŒ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:', error);
        handleCameraError(error);
      }
    }

    function scanQRCode() {
      if (!isScanning || !video.videoWidth) return;

      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height, {
        inversionAttempts: "dontInvert"
      });

      if (code) {
        const now = Date.now();
        if (code.data === lastScannedId && now - lastScannedTime < 3000) {
          return;
        }

        lastScannedId = code.data;
        lastScannedTime = now;

        console.log('ğŸ“± QRã‚³ãƒ¼ãƒ‰æ¤œå‡º:', code.data);
        
        playBeep();
        
        showMessage('info', 'âœ… QRã‚³ãƒ¼ãƒ‰æ¤œå‡ºï¼', 'å‡¦ç†ä¸­...');
        
        setTimeout(function() {
          showMessage('success', 'âœ… ã‚¹ã‚­ãƒ£ãƒ³ä¸­...', 'æ¬¡ã®QRã‚³ãƒ¼ãƒ‰ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™');
        }, 1000);

        processTicket(code.data);
      }
    }

    function playBeep() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.value = 0.3;
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
      } catch (e) {
        console.log('ãƒ“ãƒ¼ãƒ—éŸ³å†ç”Ÿã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    function handleCameraError(error) {
      let title = 'ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼';
      let message = 'ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
      
      if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
        message = 'ã‚«ãƒ¡ãƒ©ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚';
      } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
        message = 'ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒã‚¤ã‚¹ã«ã‚«ãƒ¡ãƒ©ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
        message = 'ã‚«ãƒ¡ãƒ©ãŒä»–ã®ã‚¢ãƒ—ãƒªã§ä½¿ç”¨ä¸­ã§ã™ã€‚ä»–ã®ã‚¢ãƒ—ãƒªã‚’çµ‚äº†ã—ã¦ãã ã•ã„ã€‚';
      } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
        message = 'ã‚«ãƒ¡ãƒ©ã®è¨­å®šãŒå¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚';
      } else if (error.name === 'AbortError') {
        message = 'ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸã€‚';
      } else if (error.name === 'TypeError') {
        message = 'ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚«ãƒ¡ãƒ©ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chrome ã¾ãŸã¯ Safari ã‚’ãŠä½¿ã„ãã ã•ã„ã€‚';
      }
      
      message += ' æ‰‹å‹•å…¥åŠ›ã¾ãŸã¯æ¤œç´¢ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚';
      
      showMessage('error', title, message);
      stopCamera();
    }

    function stopCamera() {
      console.log('ğŸ›‘ ã‚«ãƒ¡ãƒ©åœæ­¢');
      
      if (scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
      }
      
      if (stream) {
        stream.getTracks().forEach(function(track) {
          track.stop();
          console.log('ğŸ›‘ ãƒˆãƒ©ãƒƒã‚¯åœæ­¢:', track.kind);
        });
        stream = null;
      }
      
      video.srcObject = null;
      document.getElementById('videoContainer').style.display = 'none';
      isScanning = false;
      
      const cameraBtn = document.getElementById('cameraBtn');
      cameraBtn.textContent = 'ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•';
      cameraBtn.style.background = '';
    }

    function searchEntry() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) {
        showMessage('error', 'å…¥åŠ›ã‚¨ãƒ©ãƒ¼', 'æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const entries = JSON.parse(localStorage.getItem('citizenEntries') || '[]');
      console.log('ğŸ” æ¤œç´¢å¯¾è±¡ãƒ‡ãƒ¼ã‚¿:', entries.length, 'ä»¶');
      
      const results = entries.filter(function(entry) {
        return entry.name.includes(query) || entry.phone.includes(query);
      });

      if (results.length === 0) {
        showMessage('error', 'è©²å½“ãªã—', 'è©²å½“ã™ã‚‹äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        document.getElementById('searchResults').innerHTML = '';
        return;
      }

      if (results.length === 1) {
        processTicket(results[0].id);
        document.getElementById('searchResults').innerHTML = '';
      } else {
        displaySearchResults(results);
      }
    }

    function displaySearchResults(results) {
      const container = document.getElementById('searchResults');
      container.innerHTML = '<h4 style="color: #667eea; margin-bottom: 10px;">æ¤œç´¢çµæœï¼ˆ' + results.length + 'ä»¶ï¼‰</h4>';
      
      results.forEach(function(entry) {
        const dateLabel = dateMap[entry.date] || entry.date;
        const div = document.createElement('div');
        div.className = 'result-item';
        div.innerHTML = '<h4>' + entry.name + '</h4><p>ğŸ“… ' + dateLabel + ' ' + entry.timeslot + '</p><p>ğŸ“ ' + entry.phone + '</p><p>ğŸ« ' + entry.id + '</p>';
        div.onclick = function() {
          processTicket(entry.id);
          container.innerHTML = '';
        };
        container.appendChild(div);
      });
    }

    function recordManual() {
      const ticketId = document.getElementById('manualInput').value.trim();
      if (!ticketId) {
        showMessage('error', 'å…¥åŠ›ã‚¨ãƒ©ãƒ¼', 'ãƒã‚±ãƒƒãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      processTicket(ticketId);
      document.getElementById('manualInput').value = '';
    }

    function processTicket(ticketId) {
      console.log('ğŸ« ãƒã‚±ãƒƒãƒˆå‡¦ç†é–‹å§‹:', ticketId, 'ãƒ¢ãƒ¼ãƒ‰:', currentMode);
      
      const entries = JSON.parse(localStorage.getItem('citizenEntries') || '[]');
      console.log('ğŸ“¦ localStorage ã‹ã‚‰èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿:', entries.length, 'ä»¶');
      
      const entryIndex = entries.findIndex(function(e) { return e.id === ticketId; });
      
      if (entryIndex === -1) {
        showMessage('error', 'ã‚¨ãƒ©ãƒ¼', 'è©²å½“ã™ã‚‹äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        console.error('âŒ ã‚¨ãƒ³ãƒˆãƒªãƒ¼æœªæ¤œå‡º:', ticketId);
        console.log('ğŸ“¦ localStorage ã®å…¨ãƒ‡ãƒ¼ã‚¿:', entries);
        return;
      }

      const entry = entries[entryIndex];
      const now = new Date().toISOString();
      const dateLabel = dateMap[entry.date] || entry.date;

      if (currentMode === 'board') {
        if (entry.boardedAt) {
          showMessage('error', 'æ—¢ã«ä¹—èˆ¹æ¸ˆã¿', entry.name + ' æ§˜ã¯ ' + new Date(entry.boardedAt).toLocaleString('ja-JP') + ' ã«ä¹—èˆ¹æ¸ˆã¿ã§ã™');
          return;
        }
        entry.boardedAt = now;
        entry.scanStatus = 'boarded';
        showMessage('success', 'âœ… ä¹—èˆ¹ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ', entry.name + ' æ§˜\n' + dateLabel + ' ' + entry.timeslot);
        console.log('âœ… ä¹—èˆ¹è¨˜éŒ²å®Œäº†:', entry.name);
      } else {
        if (!entry.boardedAt) {
          showMessage('error', 'æœªä¹—èˆ¹', entry.name + ' æ§˜ã¯ã¾ã ä¹—èˆ¹ã—ã¦ã„ã¾ã›ã‚“');
          return;
        }
        if (entry.disembarkedAt) {
          showMessage('error', 'æ—¢ã«ä¸‹èˆ¹æ¸ˆã¿', entry.name + ' æ§˜ã¯ ' + new Date(entry.disembarkedAt).toLocaleString('ja-JP') + ' ã«ä¸‹èˆ¹æ¸ˆã¿ã§ã™');
          return;
        }
        entry.disembarkedAt = now;
        entry.scanStatus = 'disembarked';
        showMessage('success', 'âœ… ä¸‹èˆ¹ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ', entry.name + ' æ§˜\n' + dateLabel + ' ' + entry.timeslot);
        console.log('âœ… ä¸‹èˆ¹è¨˜éŒ²å®Œäº†:', entry.name);
      }

      entries[entryIndex] = entry;
      localStorage.setItem('citizenEntries', JSON.stringify(entries));
      console.log('ğŸ’¾ localStorage ä¿å­˜å®Œäº†');
      
      updateStats();
      console.log('ğŸ“Š çµ±è¨ˆæ›´æ–°å®Œäº†');
    }

    function updateStats() {
      const entries = JSON.parse(localStorage.getItem('citizenEntries') || '[]');
      
      const total = entries.length;
      const boarded = entries.filter(function(e) { return e.boardedAt; }).length;
      const onboard = entries.filter(function(e) { return e.boardedAt && !e.disembarkedAt; }).length;
      const disembarked = entries.filter(function(e) { return e.disembarkedAt; }).length;

      document.getElementById('totalCount').textContent = total;
      document.getElementById('boardedCount').textContent = boarded;
      document.getElementById('onboardCount').textContent = onboard;
      document.getElementById('disembarkedCount').textContent = disembarked;

      console.log('ğŸ“Š çµ±è¨ˆæ›´æ–°:', { total: total, boarded: boarded, onboard: onboard, disembarked: disembarked });
    }

    function showMessage(type, title, message) {
      const messageBox = document.getElementById('messageBox');
      messageBox.className = 'message ' + type;
      messageBox.innerHTML = '<strong>' + title + '</strong><br>' + message;
      messageBox.style.display = 'block';

      setTimeout(function() {
        messageBox.style.display = 'none';
      }, 5000);
    }

    window.addEventListener('beforeunload', function() {
      if (isScanning) {
        stopCamera();
      }
    });

    init();
  </script>
</body>
</html>
