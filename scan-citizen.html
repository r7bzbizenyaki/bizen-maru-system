<script>
    let video = document.getElementById('video');
    let canvas = document.createElement('canvas');
    let ctx = canvas.getContext('2d');
    let isScanning = false;
    let scanInterval = null;
    let lastScannedId = '';
    let lastScannedTime = 0;
    let stream = null;
    let currentMode = 'board'; // 'board' ã¾ãŸã¯ 'disembark'

    const dateMap = {
      '2026-02-27': '2æœˆ27æ—¥ï¼ˆé‡‘ï¼‰',
      '2026-03-27': '3æœˆ27æ—¥ï¼ˆé‡‘ï¼‰',
      '2026-03-28': '3æœˆ28æ—¥ï¼ˆåœŸï¼‰'
    };

    function init() {
      updateStats();
      // 5ç§’ã”ã¨ã«çµ±è¨ˆã‚’æ›´æ–°
      setInterval(updateStats, 5000);
    }

    function setMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      const modeText = mode === 'board' ? 'ä¹—èˆ¹' : 'ä¸‹èˆ¹';
      showMessage('info', `ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´`, `${modeText}ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`);
    }

    async function toggleCamera() {
      if (isScanning) {
        stopCamera();
      } else {
        await startCamera();
      }
    }

    async function startCamera() {
      try {
        console.log('ğŸ¥ ã‚«ãƒ¡ãƒ©èµ·å‹•é–‹å§‹...');
        
        // æ—¢å­˜ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒã‚ã‚Œã°åœæ­¢
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
          stream = null;
        }

        const constraints = {
          video: {
            facingMode: { ideal: "environment" },
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        };

        console.log('ğŸ“¸ getUserMedia å‘¼ã³å‡ºã—ä¸­...');
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        console.log('âœ… ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ å–å¾—æˆåŠŸ');

        video.srcObject = stream;
        await video.play();
        console.log('âœ… ãƒ“ãƒ‡ã‚ªå†ç”Ÿé–‹å§‹');

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        document.getElementById('videoContainer').style.display = 'block';
        isScanning = true;
        
        const cameraBtn = document.getElementById('cameraBtn');
        cameraBtn.textContent = 'â¸ï¸ ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢';
        cameraBtn.style.background = '#ef4444';

        scanInterval = setInterval(scanQRCode, 150);
        
        showMessage('success', 'âœ… ã‚«ãƒ¡ãƒ©èµ·å‹•å®Œäº†ï¼', 'QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«æ˜ ã—ã¦ãã ã•ã„');
        console.log('âœ… ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹');

      } catch (error) {
        console.error('âŒ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:', error);
        handleCameraError(error);
      }
    }

    function scanQRCode() {
      if (!isScanning || !video.videoWidth) return;

      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height, {
        inversionAttempts: "dontInvert",
      });

      if (code) {
        const now = Date.now();
        // 3ç§’ä»¥å†…ã®é‡è¤‡ã‚¹ã‚­ãƒ£ãƒ³ã‚’é˜²æ­¢
        if (code.data === lastScannedId && now - lastScannedTime < 3000) {
          return;
        }

        lastScannedId = code.data;
        lastScannedTime = now;

        console.log('ğŸ“± QRã‚³ãƒ¼ãƒ‰æ¤œå‡º:', code.data);
        
        // ãƒ“ãƒ¼ãƒ—éŸ³
        playBeep();
        
        showMessage('info', 'âœ… QRã‚³ãƒ¼ãƒ‰æ¤œå‡ºï¼', 'å‡¦ç†ä¸­...');
        
        // 1ç§’å¾Œã«æ¬¡ã®ã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        setTimeout(() => {
          showMessage('success', 'âœ… ã‚¹ã‚­ãƒ£ãƒ³ä¸­...', 'æ¬¡ã®QRã‚³ãƒ¼ãƒ‰ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™');
        }, 1000);

        processTicket(code.data);
      }
    }

    function playBeep() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      gainNode.gain.value = 0.3;
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.1);
    }

    function handleCameraError(error) {
      let title = 'ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼';
      let message = 'ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
      
      if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
        message = 'ã‚«ãƒ¡ãƒ©ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚';
      } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
        message = 'ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒã‚¤ã‚¹ã«ã‚«ãƒ¡ãƒ©ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
        message = 'ã‚«ãƒ¡ãƒ©ãŒä»–ã®ã‚¢ãƒ—ãƒªã§ä½¿ç”¨ä¸­ã§ã™ã€‚ä»–ã®ã‚¢ãƒ—ãƒªã‚’çµ‚äº†ã—ã¦ãã ã•ã„ã€‚';
      } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
        message = 'ã‚«ãƒ¡ãƒ©ã®è¨­å®šãŒå¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚';
      } else if (error.name === 'AbortError') {
        message = 'ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸã€‚';
      } else if (error.name === 'TypeError') {
        message = 'ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚«ãƒ¡ãƒ©ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chrome ã¾ãŸã¯ Safari ã‚’ãŠä½¿ã„ãã ã•ã„ã€‚';
      }
      
      message += ' æ‰‹å‹•å…¥åŠ›ã¾ãŸã¯æ¤œç´¢ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚';
      
      showMessage('error', title, message);
      stopCamera();
    }

    function stopCamera() {
      console.log('ğŸ›‘ ã‚«ãƒ¡ãƒ©åœæ­¢');
      
      if (scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
      }
      
      if (stream) {
        stream.getTracks().forEach(track => {
          track.stop();
          console.log('ğŸ›‘ ãƒˆãƒ©ãƒƒã‚¯åœæ­¢:', track.kind);
        });
        stream = null;
      }
      
      video.srcObject = null;
      document.getElementById('videoContainer').style.display = 'none';
      isScanning = false;
      
      const cameraBtn = document.getElementById('cameraBtn');
      cameraBtn.textContent = 'ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•';
      cameraBtn.style.background = '';
    }

    function searchEntry() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) {
        showMessage('error', 'å…¥åŠ›ã‚¨ãƒ©ãƒ¼', 'æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      // âœ… ä¿®æ­£ï¼šcitizenEntries ã‹ã‚‰èª­ã¿è¾¼ã¿
      const entries = JSON.parse(localStorage.getItem('citizenEntries') || '[]');
      console.log('ğŸ” æ¤œç´¢å¯¾è±¡ãƒ‡ãƒ¼ã‚¿:', entries.length, 'ä»¶');
      
      const results = entries.filter(entry => 
        entry.name.includes(query) || entry.phone.includes(query)
      );

      if (results.length === 0) {
        showMessage('error', 'è©²å½“ãªã—', 'è©²å½“ã™ã‚‹äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        document.getElementById('searchResults').innerHTML = '';
        return;
      }

      if (results.length === 1) {
        processTicket(results[0].id);
        document.getElementById('searchResults').innerHTML = '';
      } else {
        displaySearchResults(results);
      }
    }

    function displaySearchResults(results) {
      const container = document.getElementById('searchResults');
      container.innerHTML = '<h4 style="color: #667eea; margin-bottom: 10px;">æ¤œç´¢çµæœï¼ˆ' + results.length + 'ä»¶ï¼‰</h4>';
      
      results.forEach(entry => {
        const dateLabel = dateMap[entry.date] || entry.date;
        const div = document.createElement('div');
        div.className = 'result-item';
        div.innerHTML = `
          <h4>${entry.name}</h4>
          <p>ğŸ“… ${dateLabel} ${entry.timeslot}</p>
          <p>ğŸ“ ${entry.phone}</p>
          <p>ğŸ« ${entry.id}</p>
        `;
        div.onclick = () => {
          processTicket(entry.id);
          container.innerHTML = '';
        };
        container.appendChild(div);
      });
    }

    function recordManual() {
      const ticketId = document.getElementById('manualInput').value.trim();
      if (!ticketId) {
        showMessage('error', 'å…¥åŠ›ã‚¨ãƒ©ãƒ¼', 'ãƒã‚±ãƒƒãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      processTicket(ticketId);
      document.getElementById('manualInput').value = '';
    }

    function processTicket(ticketId) {
      console.log('ğŸ« ãƒã‚±ãƒƒãƒˆå‡¦ç†é–‹å§‹:', ticketId, 'ãƒ¢ãƒ¼ãƒ‰:', currentMode);
      
      // âœ… ä¿®æ­£ï¼šcitizenEntries ã‹ã‚‰èª­ã¿è¾¼ã¿
      const entries = JSON.parse(localStorage.getItem('citizenEntries') || '[]');
      console.log('ğŸ“¦ localStorage ã‹ã‚‰èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿:', entries.length, 'ä»¶');
      
      const entry = entries.find(e => e.id === ticketId);

      if (!entry) {
        showMessage('error', 'ã‚¨ãƒ©ãƒ¼', 'è©²å½“ã™ã‚‹äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        console.error('âŒ ã‚¨ãƒ³ãƒˆãƒªãƒ¼æœªæ¤œå‡º:', ticketId);
        console.log('ğŸ“¦ localStorage ã®å…¨ãƒ‡ãƒ¼ã‚¿:', entries);
        return;
      }

      const now = new Date().toISOString();
      const dateLabel = dateMap[entry.date] || entry.date;

      if (currentMode === 'board') {
        // ä¹—èˆ¹å‡¦ç†
        if (entry.boardedAt) {
          showMessage('error', 'æ—¢ã«ä¹—èˆ¹æ¸ˆã¿', `${entry.name} æ§˜ã¯ ${new Date(entry.boardedAt).toLocaleString('ja-JP')} ã«ä¹—èˆ¹æ¸ˆã¿ã§ã™`);
          return;
        }
        entry.boardedAt = now;
        entry.scanStatus = 'boarded';
        showMessage('success', 'âœ… ä¹—èˆ¹ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ', `${entry.name} æ§˜\n${dateLabel} ${entry.timeslot}`);
        console.log('âœ… ä¹—èˆ¹è¨˜éŒ²å®Œäº†:', entry.name);
      } else {
        // ä¸‹èˆ¹å‡¦ç†
        if (!entry.boardedAt) {
          showMessage('error', 'æœªä¹—èˆ¹', `${entry.name} æ§˜ã¯ã¾ã ä¹—èˆ¹ã—ã¦ã„ã¾ã›ã‚“`);
          return;
        }
        if (entry.disembarkedAt) {
          showMessage('error', 'æ—¢ã«ä¸‹èˆ¹æ¸ˆã¿', `${entry.name} æ§˜ã¯ ${new Date(entry.disembarkedAt).toLocaleString('ja-JP')} ã«ä¸‹èˆ¹æ¸ˆã¿ã§ã™`);
          return;
        }
        entry.disembarkedAt = now;
        entry.scanStatus = 'disembarked';
        showMessage('success', 'âœ… ä¸‹èˆ¹ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ', `${entry.name} æ§˜\n${dateLabel} ${entry.timeslot}`);
        console.log('âœ… ä¸‹èˆ¹è¨˜éŒ²å®Œäº†:', entry.name);
      }

      // âœ… ä¿®æ­£ï¼šcitizenEntries ã«ä¿å­˜
      localStorage.setItem('citizenEntries', JSON.stringify(entries));
      console.log('ğŸ’¾ localStorage ä¿å­˜å®Œäº†');
      
      // çµ±è¨ˆã‚’å³åº§ã«æ›´æ–°
      updateStats();
      console.log('ğŸ“Š çµ±è¨ˆæ›´æ–°å®Œäº†');
    }

    function updateStats() {
      // âœ… ä¿®æ­£ï¼šcitizenEntries ã‹ã‚‰èª­ã¿è¾¼ã¿
      const entries = JSON.parse(localStorage.getItem('citizenEntries') || '[]');
      
      const total = entries.length;
      const boarded = entries.filter(e => e.boardedAt).length;
      const onboard = entries.filter(e => e.boardedAt && !e.disembarkedAt).length;
      const disembarked = entries.filter(e => e.disembarkedAt).length;

      document.getElementById('totalCount').textContent = total;
      document.getElementById('boardedCount').textContent = boarded;
      document.getElementById('onboardCount').textContent = onboard;
      document.getElementById('disembarkedCount').textContent = disembarked;

      console.log('ğŸ“Š çµ±è¨ˆæ›´æ–°:', { total, boarded, onboard, disembarked });
    }

    function showMessage(type, title, message) {
      const messageBox = document.getElementById('messageBox');
      messageBox.className = 'message ' + type;
      messageBox.innerHTML = `<strong>${title}</strong><br>${message}`;
      messageBox.style.display = 'block';

      setTimeout(() => {
        messageBox.style.display = 'none';
      }, 5000);
    }

    // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢
    window.addEventListener('beforeunload', () => {
      if (isScanning) {
        stopCamera();
      }
    });

    // åˆæœŸåŒ–
    init();
  </script>
