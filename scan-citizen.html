<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‚™å‰ä¸¸ å¸‚æ°‘é™å®šå†…è¦§ä¼š ã‚¹ã‚­ãƒ£ãƒ³ç®¡ç†</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
            background: #f5f7fa;
            padding: 20px;
            padding-bottom: 100px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .header .badge {
            display: inline-block;
            background: #27ae60;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .mode-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 16px;
            border: 3px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn.active {
            border-color: #2a5298;
            background: #2a5298;
            color: white;
        }

        .mode-btn.boarding.active {
            border-color: #27ae60;
            background: #27ae60;
        }

        .mode-btn.alighting.active {
            border-color: #c41e3a;
            background: #c41e3a;
        }

        .camera-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .camera-btn {
            width: 100%;
            padding: 16px;
            background: #2a5298;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 16px;
        }

        .camera-btn:hover {
            background: #1e3c72;
            transform: translateY(-2px);
        }

        .camera-btn.active {
            background: #c41e3a;
        }

        #reader {
            border-radius: 12px;
            overflow: hidden;
            display: none;
        }

        #reader.active {
            display: block;
        }

        .manual-input {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .manual-input h3 {
            font-size: 18px;
            margin-bottom: 16px;
            color: #333;
        }

        .input-group {
            display: flex;
            gap: 12px;
        }

        .input-group input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .input-group button {
            padding: 12px 24px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .input-group button:hover {
            background: #229954;
        }

        .message-box {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: none;
        }

        .message-box.show {
            display: block;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-box.success {
            background: #e8f5e9;
            border: 3px solid #27ae60;
        }

        .message-box.error {
            background: #ffebee;
            border: 3px solid #c41e3a;
        }

        .message-box.info {
            background: #e3f2fd;
            border: 3px solid #1976d2;
        }

        .message-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .message-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .message-text {
            font-size: 16px;
            color: #666;
        }

        .stats-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .stat-card {
            text-align: center;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #2a5298;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: #666;
        }

        .log-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .log-section h3 {
            font-size: 18px;
            margin-bottom: 16px;
            color: #333;
        }

        .log-item {
            padding: 12px;
            border-left: 4px solid #2a5298;
            background: #f8f9fa;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 14px;
        }

        .log-item.boarding {
            border-left-color: #27ae60;
        }

        .log-item.alighting {
            border-left-color: #c41e3a;
        }

        .log-time {
            color: #999;
            font-size: 12px;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #e0e0e0;
            padding: 12px 20px;
            display: flex;
            gap: 12px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
        }

        .nav-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .nav-btn.dashboard {
            background: #2a5298;
            color: white;
        }

        .nav-btn.clear {
            background: #c41e3a;
            color: white;
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="badge">ğŸ›ï¸ ä¿‚å“¡ç”¨</div>
            <h1>ğŸš¢ å‚™å‰ä¸¸ ã‚¹ã‚­ãƒ£ãƒ³ç®¡ç†</h1>
            <p>QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦è¨˜éŒ²ã—ã¾ã™</p>
        </div>

        <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
        <div class="mode-selector">
            <button class="mode-btn boarding active" id="boardingBtn" onclick="setMode('boarding')">
                ğŸš¢ ä¹—èˆ¹
            </button>
            <button class="mode-btn alighting" id="alightingBtn" onclick="setMode('alighting')">
                ğŸ‘‹ ä¸‹èˆ¹
            </button>
        </div>

        <!-- ã‚«ãƒ¡ãƒ©ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="camera-section">
            <button class="camera-btn" id="cameraBtn" onclick="toggleCamera()">
                ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
            </button>
            <div id="reader"></div>
        </div>

        <!-- æ‰‹å‹•å…¥åŠ› -->
        <div class="manual-input">
            <h3>ğŸ“ æ‰‹å‹•å…¥åŠ›</h3>
            <div class="input-group">
                <input type="text" id="manualInput" placeholder="ãƒã‚±ãƒƒãƒˆIDã‚’å…¥åŠ›ï¼ˆä¾‹: CM1234567890ï¼‰">
                <button onclick="recordManual()">è¨˜éŒ²</button>
            </div>
        </div>

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ -->
        <div class="message-box" id="messageBox">
            <div class="message-icon" id="messageIcon"></div>
            <div class="message-title" id="messageTitle"></div>
            <div class="message-text" id="messageText"></div>
        </div>

        <!-- çµ±è¨ˆ -->
        <div class="stats-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalReservations">0</div>
                    <div class="stat-label">ç·äºˆç´„æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalBoarded">0</div>
                    <div class="stat-label">ä¹—èˆ¹æ¸ˆã¿</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="currentOnboard">0</div>
                    <div class="stat-label">ç¾åœ¨ä¹—èˆ¹ä¸­</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalCompleted">0</div>
                    <div class="stat-label">ä¸‹èˆ¹æ¸ˆã¿</div>
                </div>
            </div>
        </div>

        <!-- ã‚¹ã‚­ãƒ£ãƒ³ãƒ­ã‚° -->
        <div class="log-section">
            <h3>ğŸ“‹ ã‚¹ã‚­ãƒ£ãƒ³ãƒ­ã‚°</h3>
            <div id="logContainer">
                <p style="text-align: center; color: #999; padding: 20px;">ã¾ã ã‚¹ã‚­ãƒ£ãƒ³è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        </div>
    </div>

    <!-- ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="bottom-nav">
        <button class="nav-btn dashboard" onclick="window.open('dashboard-citizen.html', '_blank')">
            ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
        </button>
        <button class="nav-btn clear" onclick="clearAllData()">
            ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        </button>
    </div>

    <script>
        let currentMode = 'boarding'; // 'boarding' or 'alighting'
        let html5QrCode = null;
        let isScanning = false;
        let lastScannedId = null;
        let lastScannedTime = 0;

        // åˆæœŸåŒ–
        function init() {
            console.log('ğŸš€ ã‚¹ã‚­ãƒ£ãƒ³ç®¡ç†ç”»é¢åˆæœŸåŒ–');
            updateStats();
            loadLogs();
            
            // 5ç§’ã”ã¨ã«çµ±è¨ˆã‚’æ›´æ–°
            setInterval(updateStats, 5000);
        }

        // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        function setMode(mode) {
            currentMode = mode;
            
            document.getElementById('boardingBtn').classList.remove('active');
            document.getElementById('alightingBtn').classList.remove('active');
            
            if (mode === 'boarding') {
                document.getElementById('boardingBtn').classList.add('active');
            } else {
                document.getElementById('alightingBtn').classList.add('active');
            }
            
            console.log('ğŸ“ ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿:', mode);
        }

        // ã‚«ãƒ¡ãƒ©èµ·å‹•/åœæ­¢
        function toggleCamera() {
            if (isScanning) {
                stopCamera();
            } else {
                startCamera();
            }
        }

        // ã‚«ãƒ¡ãƒ©èµ·å‹•
        function startCamera() {
            const reader = document.getElementById('reader');
            const btn = document.getElementById('cameraBtn');
            
            reader.classList.add('active');
            btn.textContent = 'â¹ï¸ ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢';
            btn.classList.add('active');
            isScanning = true;

            html5QrCode = new Html5Qrcode("reader");
            
            html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                (decodedText) => {
                    handleScan(decodedText);
                },
                (errorMessage) => {
                    // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­ã¯å¸¸ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ï¼‰
                }
            ).catch((err) => {
                console.error('âŒ ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:', err);
                showMessage('error', 'ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼', 'ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ');
                stopCamera();
            });

            console.log('ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•');
        }

        // ã‚«ãƒ¡ãƒ©åœæ­¢
        function stopCamera() {
            const reader = document.getElementById('reader');
            const btn = document.getElementById('cameraBtn');
            
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    reader.classList.remove('active');
                    btn.textContent = 'ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•';
                    btn.classList.remove('active');
                    isScanning = false;
                    console.log('â¹ï¸ ã‚«ãƒ¡ãƒ©åœæ­¢');
                }).catch((err) => {
                    console.error('âŒ ã‚«ãƒ¡ãƒ©åœæ­¢ã‚¨ãƒ©ãƒ¼:', err);
                });
            }
        }

        // ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç†
        function handleScan(ticketId) {
            // é‡è¤‡ã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢ï¼ˆ2ç§’ä»¥å†…ï¼‰
            const now = Date.now();
            if (ticketId === lastScannedId && now - lastScannedTime < 2000) {
                console.log('âš ï¸ é‡è¤‡ã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢:', ticketId);
                return;
            }
            
            lastScannedId = ticketId;
            lastScannedTime = now;

            console.log('ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³:', ticketId, 'ãƒ¢ãƒ¼ãƒ‰:', currentMode);
            processTicket(ticketId);
        }

        // æ‰‹å‹•å…¥åŠ›
        function recordManual() {
            const input = document.getElementById('manualInput');
            const ticketId = input.value.trim();
            
            if (!ticketId) {
                showMessage('error', 'å…¥åŠ›ã‚¨ãƒ©ãƒ¼', 'ãƒã‚±ãƒƒãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            console.log('ğŸ“ æ‰‹å‹•å…¥åŠ›:', ticketId, 'ãƒ¢ãƒ¼ãƒ‰:', currentMode);
            processTicket(ticketId);
            input.value = '';
        }

        // ãƒã‚±ãƒƒãƒˆå‡¦ç†
        function processTicket(ticketId) {
            console.log('ğŸ” ãƒã‚±ãƒƒãƒˆå‡¦ç†é–‹å§‹:', ticketId);
            
            // ãƒ‡ãƒ¼ã‚¿å–å¾—
            const entries = JSON.parse(localStorage.getItem('citizenEntries') || '[]');
            const entryIndex = entries.findIndex(e => e.id === ticketId);
            
            if (entryIndex === -1) {
                showMessage('error', 'ã‚¨ãƒ©ãƒ¼', 'ãƒã‚±ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                console.error('âŒ ãƒã‚±ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', ticketId);
                return;
            }
            
            const entry = entries[entryIndex];
            
            // æ—¥ä»˜ãƒãƒƒãƒ”ãƒ³ã‚°
            const dateMap = {
                '2026-02-27': '2æœˆ27æ—¥ï¼ˆé‡‘ï¼‰',
                '2026-03-27': '3æœˆ27æ—¥ï¼ˆé‡‘ï¼‰',
                '2026-03-28': '3æœˆ28æ—¥ï¼ˆåœŸï¼‰'
            };
            
            if (currentMode === 'boarding') {
                // ä¹—èˆ¹å‡¦ç†
                if (entry.boardingTime) {
                    showMessage('info', 'æ—¢ã«ä¹—èˆ¹æ¸ˆã¿', `${entry.name}ã•ã‚“ã¯æ—¢ã«ä¹—èˆ¹æ¸ˆã¿ã§ã™`);
                    return;
                }
                
                entry.boardingTime = Date.now();
                entry.status = 'boarded';
                entries[entryIndex] = entry;
                localStorage.setItem('citizenEntries', JSON.stringify(entries));
                localStorage.setItem('lastUpdate', Date.now().toString());
                
                showMessage('success', 'ä¹—èˆ¹ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ', `${entry.name}ã•ã‚“\näºˆç´„: ${dateMap[entry.date]} ${entry.timeslot}ã€œ`);
                addLog('boarding', entry.name, ticketId);
                
            } else {
                // ä¸‹èˆ¹å‡¦ç†
                if (!entry.boardingTime) {
                    showMessage('error', 'ã‚¨ãƒ©ãƒ¼', `${entry.name}ã•ã‚“ã¯ã¾ã ä¹—èˆ¹ã—ã¦ã„ã¾ã›ã‚“`);
                    return;
                }
                
                if (entry.alightingTime) {
                    showMessage('info', 'æ—¢ã«ä¸‹èˆ¹æ¸ˆã¿', `${entry.name}ã•ã‚“ã¯æ—¢ã«ä¸‹èˆ¹æ¸ˆã¿ã§ã™`);
                    return;
                }
                
                entry.alightingTime = Date.now();
                entry.status = 'completed';
                entries[entryIndex] = entry;
                localStorage.setItem('citizenEntries', JSON.stringify(entries));
                localStorage.setItem('lastUpdate', Date.now().toString());
                
                const stayTime = Math.round((entry.alightingTime - entry.boardingTime) / 60000);
                showMessage('success', 'ä¸‹èˆ¹ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ', `${entry.name}ã•ã‚“\næ»åœ¨æ™‚é–“: ${stayTime}åˆ†`);
                addLog('alighting', entry.name, ticketId);
            }
            
            updateStats();
            console.log('âœ… ãƒã‚±ãƒƒãƒˆå‡¦ç†å®Œäº†:', entry);
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(type, title, text) {
            const box = document.getElementById('messageBox');
            const icon = document.getElementById('messageIcon');
            const titleElem = document.getElementById('messageTitle');
            const textElem = document.getElementById('messageText');
            
            box.className = 'message-box show ' + type;
            
            if (type === 'success') {
                icon.textContent = 'âœ…';
                box.style.color = '#2e7d32';
            } else if (type === 'error') {
                icon.textContent = 'âŒ';
                box.style.color = '#c62828';
            } else if (type === 'info') {
                icon.textContent = 'â„¹ï¸';
                box.style.color = '#1976d2';
            }
            
            titleElem.textContent = title;
            textElem.textContent = text;
            
            setTimeout(() => {
                box.classList.remove('show');
            }, 3000);
        }

        // ãƒ­ã‚°è¿½åŠ 
        function addLog(type, name, ticketId) {
            const logs = JSON.parse(localStorage.getItem('scanLogs') || '[]');
            const now = new Date();
            
            logs.unshift({
                type: type,
                name: name,
                ticketId: ticketId,
                timestamp: now.getTime(),
                timeStr: now.toLocaleTimeString('ja-JP')
            });
            
            // æœ€æ–°50ä»¶ã®ã¿ä¿å­˜
            if (logs.length > 50) {
                logs.splice(50);
            }
            
            localStorage.setItem('scanLogs', JSON.stringify(logs));
            loadLogs();
        }

        // ãƒ­ã‚°èª­ã¿è¾¼ã¿
        function loadLogs() {
            const logs = JSON.parse(localStorage.getItem('scanLogs') || '[]');
            const container = document.getElementById('logContainer');
            
            if (logs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">ã¾ã ã‚¹ã‚­ãƒ£ãƒ³è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            let html = '';
            logs.slice(0, 10).forEach(log => {
                const typeText = log.type === 'boarding' ? 'ğŸš¢ ä¹—èˆ¹' : 'ğŸ‘‹ ä¸‹èˆ¹';
                html += `
                    <div class="log-item ${log.type}">
                        <div><strong>${typeText}</strong> - ${log.name}</div>
                        <div style="font-size: 12px; color: #999; margin-top: 4px;">
                            ${log.timeStr} | ${log.ticketId}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            const entries = JSON.parse(localStorage.getItem('citizenEntries') || '[]');
            
            const total = entries.length;
            const boarded = entries.filter(e => e.boardingTime).length;
            const completed = entries.filter(e => e.alightingTime).length;
            const onboard = boarded - completed;
            
            document.getElementById('totalReservations').textContent = total;
            document.getElementById('totalBoarded').textContent = boarded;
            document.getElementById('currentOnboard').textContent = onboard;
            document.getElementById('totalCompleted').textContent = completed;
            
            console.log('ğŸ“Š çµ±è¨ˆæ›´æ–°:', { total, boarded, onboard, completed });
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearAllData() {
            if (!confirm('æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            
            if (!confirm('æœ€çµ‚ç¢ºèªï¼šã™ã¹ã¦ã®äºˆç´„ãƒ‡ãƒ¼ã‚¿ã¨ã‚¹ã‚­ãƒ£ãƒ³ãƒ­ã‚°ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚\næœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            localStorage.removeItem('citizenEntries');
            localStorage.removeItem('scanLogs');
            localStorage.setItem('lastUpdate', Date.now().toString());
            
            updateStats();
            loadLogs();
            
            showMessage('success', 'å‰Šé™¤å®Œäº†', 'å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            console.log('ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢å®Œäº†');
        }

        // storage ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸï¼‰
        window.addEventListener('storage', function(e) {
            if (e.key === 'citizenEntries' || e.key === 'lastUpdate') {
                console.log('ğŸ”„ ä»–ã®ã‚¿ãƒ–ã‹ã‚‰ã®æ›´æ–°æ¤œå‡º');
                updateStats();
            }
            
            if (e.key === 'scanLogs') {
                loadLogs();
            }
        });

        // åˆæœŸåŒ–å®Ÿè¡Œ
        init();

        console.log('ğŸš€ ã‚¹ã‚­ãƒ£ãƒ³ç®¡ç†ç”»é¢èµ·å‹•å®Œäº†');
    </script>
</body>
</html>